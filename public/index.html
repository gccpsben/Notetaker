<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
        <style> @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap'); </style>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <script src="./urlJoin.js"></script>
        <script src="./jquery.min.js"></script>
    </head>
    <body style="margin:0px; background: #1a1a17;">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        
        <div id="app">

            <div v-if="contextMenuTarget != undefined">
                <div v-on:click="contextMenuTarget = undefined" style="position:fixed; width:100%; height:100%; background:#00000001; z-index:98;"></div>
                <div v-if="contextMenuTarget.type == 'note'">
                    <div :style="{'left': contextMenuTarget.x, 'top': contextMenuTarget.y}" style="position:fixed; width:150px; height:500px; background:#222222; z-index:99; border: 1px solid #444444;">
                        <div v-on:click="renameNoteButtonClicked(contextMenuTarget.name)" style="width:100%; height:30px; border-bottom: 1px solid #444444;">
                            <h1 style="font-size:16px; cursor:pointer; color:white; margin:0px; font-weight: 100; margin:10px;">Rename</h1>
                        </div>
                    </div>
                </div>
                <div v-if="contextMenuTarget.type == 'folder'">
                    <div :style="{'left': contextMenuTarget.x, 'top': contextMenuTarget.y}" style="position:fixed; width:150px; height:500px; background:#222222; z-index:99; border: 1px solid #444444;">
                        <div v-on:click="renameFolderButtonClicked(contextMenuTarget.name)" style="width:100%; height:30px; border-bottom: 1px solid #444444;">
                            <h1 style="font-size:16px; cursor:pointer; color:white; margin:0px; font-weight: 100; margin:10px;">Rename</h1>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentPastedMedia != undefined">
                <div v-if="currentPastedMedia.type == 'image'">
                    <div class="maxCenter" style="position:fixed; background:#000000AA; z-index:999;">
                        <div style="width:500px; height:500px; background:#333333; border-radius: 5px; display:grid; grid-template-columns: 1fr; grid-template-rows: 45px 1fr 43px; grid-template-areas: 'top' 'content' 'bottom';">
                            <div class="verticallyCenter" style="grid-area:top; padding:15px;">
                                <h1 style="color:white; margin:0px; padding:0px; font-size:15px; font-weight: 100;">Upload and insert this image?</h1>
                            </div>
                            <div style="grid-area:content; width:100%; background:#222222;">
                                <div :style="{'background-image': `url(${currentPastedMedia.base64})`}" style="width:100%; height:100%; background-size: contain; background-position: center; background-repeat: no-repeat;"></div>
                            </div>
                            <div class="maxCenter" style="grid-area:bottom; width:100%;">
                                <center>
                                    <button v-on:click="uploadMedia(currentPastedMedia)" class="pasteModelConfirmButton">
                                        <span style="color:white; font-size: 20px; transform:translateY(1px)" class="material-icons">done</span>
                                    </button>
                                    <button v-on:click="currentPastedMedia = undefined" class="pasteModelConfirmButton" style="margin:0px;">
                                        <span style="color:white; font-size: 20px; transform:translateY(1px)" class="material-icons">close</span>
                                    </button>
                                </center>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="mainGrid" v-show="isLoggedIn" :class="{ 'leftPanelHidden':pageWidth <= maxWidthToBeMobile ? currentNoteName != undefined : false, 'rightPanelHidden':pageWidth <= maxWidthToBeMobile ? currentNoteName == undefined : false }">

                <div v-show="!isSocketDisconnected" style="margin:0px; grid-area: right; position:relative; overflow: hidden;">
                    <div v-show="currentNoteName == undefined" class="maxCenter" style="background:#222222">
                        <div>
                            <center><span class="material-icons" style="color: #fff; font-size: 100px; margin-bottom: 20px; ">file_open</span></center>
                            <center><h1 style="font-size:20px; color:#fff; margin:0px; font-weight: 100;">Open a note to continue</h1></center>
                        </div>
                    </div>
                    <div :style="{'opacity':(currentNoteName ? 1:0)}" style="margin:0px; position:absolute; bottom:0px; top:0px; left:0; right:0;">
                        <iframe id="editorIframe" src="./editor.html" style="border:0px; width:100%; height:100%;"></iframe>
                    </div>
                </div>

                <div v-show="isSocketDisconnected" class="maxCenter" style="margin:0px; grid-area: right; position:relative;">
                    <div>
                        <center><span class="material-icons" style="color: #ffb6b6; font-size: 100px;">wifi_off</span></center>
                        <center><h1 style="font-size:20px; color:#ffb6b6; margin:0px; font-weight: 100;">Connection Lost...</h1></center>
                    </div>
                </div>

                <div class="fullSize" style="overflow: hidden; margin:0px; grid-area: left; display:grid; grid-template-columns: 1fr; grid-template-rows:42px 42px 1fr 30px; 
                grid-template-areas: 'top' 'search' 'content' 'bottom'; background:#1a1a17;">

                    <div style="grid-area: top; border-bottom:1px solid #333333; position: relative;" class="verticallyCenter horiCenter">
                        <div v-on:click="goUpFolder()" style="position:absolute; left:15px; cursor:pointer;">
                            <span :class="{'materialIconDisabled':currentPath=='/'}" style="user-select: none; color:white; font-size: 20px; transform:translateY(2px)" class="material-icons">chevron_left</span>
                        </div>
                        <h1 class="h1Min">{{currentPathShortName}}</h1>
                        <div style="position:absolute; right:15px; cursor:pointer;">
                            <span v-on:click="createNote()" style="color:white; font-size: 20px; transform:translateY(1px)" class="material-icons">note_add</span>
                            <span v-on:click="createFolder()" style="color:white; margin-left:15px; font-size: 20px; transform:translateY(1px)" class="material-icons">create_new_folder</span>
                        </div>
                    </div>

                    <div style="grid-area: search; border-bottom:1px solid #333333; position: relative;" class="verticallyCenter horiCenter">
                        <div style="width:100%; height:100%; display: grid; grid-template-columns: 50px 1fr; grid-template-rows: 1fr; grid-template-areas: 'left right';">
                            <div class="maxCenter" style="grid-area: left; color:white;">
                                <span style="font-size: 20px; transform:translateY(1px)" class="material-icons">search</span>
                            </div>
                            <input v-model="currentSearchWords" type="text" style=" outline: none; grid-area: right; height:100%; background:transparent; color:white; border:0px;" placeholder="Search for names, tags etc..."></input>
                        </div>
                    </div>

                    <div v-if="!isDirectoryLoading" style="grid-area: content;" id="filesSelectorPanel">
                        <div v-for="note in currentPathNotesFiltered" data-type="note" :data-name="note.name">
                            <div data-type="note" :data-name="note.name" :class="{'currentNote': currentNoteName == note.name, 'noteModified': modifiedNoteNames.includes(note.name) }" v-on:click="openNote(note.name)" class="verticallyCenter noteSelector">
                                <h1 data-type="note" :data-name="note.name" class="h1Min">{{note.name}}</h1>
                            </div>
                        </div>
                        <div v-for="folder in currentPathFoldersFiltered">
                            <div data-type="folder" :data-name="folder.name" v-on:click="openFolder(folder.name)" v-on:click="alert(folder.name)" class="verticallyCenter noteSelector">
                                <div data-type="folder" :data-name="folder.name" style="position:relative; width:100%;">
                                    <h1 data-type="folder" :data-name="folder.name" class="h1Min">{{folder.name}}</h1>
                                    <span data-type="folder" :data-name="folder.name" style="color:white; position:absolute; right:0px; top:0px;" class="material-icons md-dark">chevron_right</span>
                                </div>
                            </div>
                        </div>
                        <div v-if="currentPathFiles.length == 0">
                            <div class="maxCenter">
                                <div>
                                    <center><span style="color:white;" class="material-icons md-dark">book</span></center>
                                    <br>
                                    <h1 class="h1Min">Folder Empty</h1>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="isDirectoryLoading" style="grid-area: content; background:#1a1a17;" id="filesSelectorPanel">
                        <div class="maxCenter">
                            <div>
                                <center><div style="color:white;" class="loadingIcon"></div></center>
                                <br>
                                <center><h1 style="font-size:15px; font-weight: 100; color:white;">Loading</h1></center>
                            </div>
                        </div>
                    </div>

                    <div style="grid-area: bottom; background:#1a1a17; border-top:1px solid #333333; position:relative" class="verticallyCenter">
                        <div style="position:absolute; color:white; width:100%; height:100%;">
                            <div class="maxCenter" style="font-size:14px;">{{currentTimeString}}</div>
                        </div>
                        <div style="position:absolute; right:0px; padding-left:15px; padding-right:15px; font-size: 15px;">
                            <span v-if="!isSocketDisconnected" style="font-size:inherit; color:lightgreen;" class="material-icons">wifi_password</span>
                            <span v-if="isSocketDisconnected" style="font-size:inherit; color:red;" class="material-icons">wifi_off</span>
                        </div>
                        <div style="position:absolute; left:0px; padding-left:15px; padding-right:15px; ">
                            <span style="color:white; font-size: 15px;" class="material-icons">settings</span>
                        </div>
                    </div>

                </div>
            </div>

            <div id="loginGrid" v-if="!isLoggedIn" style="height:100%; display:flex; justify-content:center; align-items:center;">
                <div style="width:500px; height:500px; background:#222222; border-radius: 15px;">
                    <div style="display:grid; height:100%; grid-template-rows: 1fr 45px 45px 60px 1fr; grid-template-columns: 1fr;">
                        <div></div>
                        <div class="maxCenter"><input v-model="loginUsername" placeholder="Username..."/></div>
                        <div class="maxCenter"><input v-model="loginPassword" placeholder="Password..." type="password"/></div>
                        <div class="maxCenter"><button style="width:50px; height:30px;" @click="login">Login</button></div>
                        <div></div>
                    </div>
                </div>
            </div>

            <!-- <div v-if="isSocketDisconnected" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                <div>
                    <h1 style="color:#4e5773; font-weight:100;">Lost Connection...</h1>
                    <center>
                        <button style="border:1px solid #333333; padding:5px; font-size:15px; background:#222222; color:white;">Reconnect</button>
                    </center>
                </div>
            </div> -->

        </div>

        <script>
        const { createApp } = Vue;

        createApp(
        {
            methods:
            {
                login()
                {
                    var self = this;
                    var fetchOptions = 
                    {
                        method: "POST", headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(
                        {
                            username:self.loginUsername, password:self.loginPassword
                        })
                    };
                    fetch("/login", fetchOptions)
                    .then(response => 
                    {
                        if (response.status == 401) { alert("Incorrect password or username."); return; }
                        return response.json();
                    })
                    .then(dataJSON => 
                    {
                        alert(dataJSON);
                        self.setCookie("token", dataJSON.token, 7);
                        self.setCookie("username", self.loginUsername, 7);
                        window.location.reload();
                    });
                },
                isAuthAvailable()
                {
                    return this.getCookie("token") != null && this.getCookie("username") != null;
                },
                authPost(url, body, noRefresh=false)
                {
                    var self = this;
                    var queryURL = `${url}`;

                    return fetch(queryURL,
                    {
                        method: "POST", headers: 
                        { 
                            'Content-Type': 'application/json',
                            "authorization": self.getCookie("token"),
                            "auth-username": self.getCookie("username")
                        },
                        body: JSON.stringify(body)
                    }).then(response => 
                    {
                        if (response.status == 401 && noRefresh == false) self.resetSession();
                        else return response.text();
                    });
                },
                authGet(url)
                {
                    var self = this;
                    var queryURL = `${url}`;

                    return fetch(queryURL, 
                    {
                        method: "GET",
                        headers: 
                        {
                            "authorization": self.getCookie("token"),
                            "auth-username": self.getCookie("username")
                        }
                    }).then(response => 
                    {
                        if (response.status == 401) self.resetSession();
                        else return response.text();
                    });
                },
                resetSession()
                {
                    this.eraseCookie("token");
                    this.eraseCookie("username");
                    window.location.reload();
                },
                setCookie(name,value,days) 
                {
                    var expires = "";
                    if (days) 
                    {
                        var date = new Date();
                        date.setTime(date.getTime() + (days*24*60*60*1000));
                        expires = "; expires=" + date.toUTCString();
                    }
                    document.cookie = name + "=" + (value || "")  + expires + "; path=/;SameSite=Lax";
                },
                getCookie(name) 
                {
                    var nameEQ = name + "=";
                    var ca = document.cookie.split(';');
                    for(var i=0;i < ca.length;i++) {
                        var c = ca[i];
                        while (c.charAt(0)==' ') c = c.substring(1,c.length);
                        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
                    }
                    return null;
                },
                eraseCookie(name) 
                {
                    document.cookie = name+'=; Max-Age=-99999999;';
                },
                updateToolbarMode()
                {
                    var self = this;
                    var oldToolbarMode = self.editor.settings.toolbarIcons;
                    self.pageHeight = window.innerHeight;
                    self.pageWidth = window.innerWidth;

                    if (self.pageWidth <= self.maxWidthToBeMobile) self.editor.settings.toolbarIcons = "defaultMobile";
                    else self.editor.settings.toolbarIcons = "defaultFull";
                    if (oldToolbarMode != self.editor.settings.toolbarIcons) self.editor.setToolbar();
                },
                uploadMedia(currentPastedObjectJSON)
                {
                    alert("not done haha");
                },
                renameNote(oldName, newName)
                {
                    var path = urlJoin(this.currentPath, "/");
                    var self = this;
                    
                    self.authPost("./renameNote", 
                    {
                        path: path,
                        oldName: oldName,
                        newName: newName,
                        socketIoId: this.socket.io.engine.id
                    })
                    .then(response => response.text())
                    .then(data => { })
                    .catch((e) => { alert(e); });
                },
                renameFolder(oldName, newName)
                {
                    var path = urlJoin(this.currentPath, "/");
                    var self = this;
                    
                    self.authPost("./renameFolder", 
                    {
                        path: path,
                        oldName: oldName,
                        newName: newName,
                        socketIoId: this.socket.io.engine.id
                    })
                    .then(data => { })
                    .catch((e) => { alert(e); });
                },
                updateCurrentDirectoryFiles()
                {
                    var path = urlJoin(this.currentPath, "/");
                    //currentPath = path;
                    var queryURL = `./listDir?path=${path}`;
                    var self = this;
                    
                    self.isDirectoryLoading = true;
                    self.authGet(queryURL)
                    .then(data => 
                    {
                        setTimeout(() => 
                        {
                            self.currentPathFiles = JSON.parse(data);
                            self.isDirectoryLoading = false;
                        }, 100);
                    })
                    // there's problem fetching data from server
                    .catch(() => 
                    {
                        self.isSocketDisconnected = true;
                    });
                },
                filterCurrentObjects: function()
                {
                    var term = this.currentSearchWords;
                    return this.currentPathFiles.filter(item => { return item.name.includes(term); });
                },
                urlGoUp: function(url)
                {
                    if (url.endsWith("/")) url = url.substring(0,url.length-1)
                    const lastSlashPosition = url.lastIndexOf("/"); 
                    var output = url.substring(0,lastSlashPosition);
                    if (output == "") output = "/";
                    return output;
                },
                saveNote: function()
                {
                    document.title = Math.random();
                    var self = this;
                    var directory = urlJoin(this.currentWorkingPath, "/")
                    var name = this.currentNoteName;
                    var newContent = $(`#editorIframe`).get(0).contentWindow.editor.getValue();
                    $(`#editorIframe`).get(0).contentWindow.$(`#lastSavedLabel`).get(0).innerText = "Saving...";
                    self.authPost("./updateNote", 
                    {
                        path: directory,
                        name: name,
                        content: newContent,
                        socketIoId: this.socket.io.engine.id
                    })
                    .then(data => 
                    {
                        var options = { hour: '2-digit',minute:'2-digit',second:'2-digit' };
                        var today  = new Date();
                        $(`#editorIframe`).get(0).contentWindow.$(`#lastSavedLabel`).get(0).innerText = `Last Saved ${today.toLocaleDateString("en-US", options)}`;
                    })

                    // there's problem fetching data from server
                    .catch(() => 
                    {
                        self.isSocketDisconnected = true;
                    });
                },
                createNote: function ()
                {
                    var suitableName = "";
                    var suitableNameFound = false;
                    var currentCount = 1;
                    while (!suitableNameFound)
                    {
                        var proposedName = `new note ${currentCount}`;
                        if (!this.currentPathFiles.some(item => {  return item.name == proposedName && item.type == "note"  })) 
                        {
                            suitableName = proposedName;
                            suitableNameFound = true;
                        }
                        else { currentCount++; }
                    }
                    
                    var self = this;
                    var directory = urlJoin(this.currentPath, "/")
                    self.authPost("./createNote", 
                    {
                        path: directory,
                        name: suitableName,
                        socketIoId: this.socket.io.engine.id
                    })
                    .then(data => 
                    { 
                        self.updateCurrentDirectoryFiles(); 
                        self.openNote(suitableName);
                    })
                    // there's problem fetching data from server
                    .catch(() => 
                    {
                        self.isSocketDisconnected = true;
                    });
                },
                createFolder: function ()
                {
                    var suitableName = "";
                    var suitableNameFound = false;
                    var currentCount = 1;
                    while (!suitableNameFound)
                    {
                        var proposedName = `new folder ${currentCount}`;
                        if (!this.currentPathFiles.some(item => {  return item.name == proposedName && item.type == "folder"  })) 
                        {
                            suitableName = proposedName;
                            suitableNameFound = true;
                        }
                        else { currentCount++; }
                    }
                    
                    var self = this;
                    var directory = urlJoin(this.currentPath, "/")
                    self.authPost("./createFolder", 
                    {
                        path: directory,
                        name: suitableName,
                        socketIoId: this.socket.io.engine.id
                    })
                    .then(data => { self.updateCurrentDirectoryFiles(); })
                    // there's problem fetching data from server
                    .catch(() => { self.isSocketDisconnected = true; });
                },
                openNote: function(noteName, skipLoading = false)
                {
                    this.updateToolbarMode();
                    this.modifiedNoteNames = this.modifiedNoteNames.filter(i => { return i != noteName });
                    var path = urlJoin(urlJoin(this.currentPath), "/");
                    // if (this.currentWorkingPath == path && noteName == this.currentNoteName) return;
                    if (!skipLoading) $(`#editorIframe`).get(0).contentWindow.postMessage("displayLoadingPage", "*");
                    document.title = noteName;
                    var queryURL = `./listDir?path=${path}`;
                    var editor = this.editor;
                    var self = this;
                    
                    self.authGet(queryURL)
                    .then(data => 
                    {
                        JSON.parse(data).forEach((object) => 
                        {
                            if (object.name == noteName && object.type == "note")
                            {
                                var newContent = object.content;
                                var oldContent = $(`#editorIframe`).get(0).contentWindow.editor.getValue();
                                var oldCursor = editor.getCursor();
                                if (oldContent != newContent) 
                                {
                                    self.preventSaving = true;
                                    $(`#editorIframe`).get(0).contentWindow.editor.setValue(object.content);
                                    //setTimeout(() => { editor.setCursor(oldCursor); }, 100);
                                    setTimeout(() => 
                                    {
                                        self.preventSaving = false; 
                                    }, 1000);
                                }
                                self.secondsLeftToSaveNote = -1;
                                if (!skipLoading) $(`#editorIframe`).get(0).contentWindow.postMessage("hideLoadingPage", "*");
                            }
                        });
                        this.currentNoteName = noteName;
                        this.currentWorkingPath = path;
                        self.isSocketDisconnected = false;
                    })
                    // there's problem fetching data from server
                    .catch(() => 
                    {
                        self.isSocketDisconnected = true;
                    });
                },
                openFolder: function(folderName)
                {
                    //this.currentNoteName = undefined;
                    this.currentPath = urlJoin(urlJoin(this.currentPath, folderName), "/");
                    this.updateToolbarMode();
                },
                goUpFolder: function()
                {
                    //this.currentNoteName = undefined;
                    this.currentPath = urlJoin(this.urlGoUp(this.currentPath), "/");
                },
                renameNoteButtonClicked: function(oldNoteName)
                {
                    this.contextMenuTarget = undefined; 
                    setTimeout(() => 
                    {
                        var newName = window.prompt('Please enter a new name');
                        if (newName == null) return;
                        this.renameNote(oldNoteName, newName);
                    }, 100);
                },
                renameFolderButtonClicked: function(oldNoteName)
                {
                    this.contextMenuTarget = undefined; 
                    setTimeout(() => 
                    {
                        var newName = window.prompt('Please enter a new name');
                        if (newName == null) return;
                        this.renameFolder(oldNoteName, newName);
                    }, 100);
                },
            },
            computed:
            {
                currentPathNotesFiltered()
                {
                    return this.filterCurrentObjects().filter(i => { return i.type == "note"; });
                },
                currentPathFoldersFiltered()
                {
                    return this.filterCurrentObjects().filter(i => { return i.type == "folder"; });
                },
                currentPathNotes()
                {
                    return this.currentPathFiles.filter(i => { return i.type == "note"; });
                },
                currentPathFolders()
                {
                    return this.currentPathFiles.filter(i => { return i.type == "folder"; });
                },
                // This is the text shown on the navbar, this will only get the last folder in the path, to avoid long path names taking up too many space.
                currentPathShortName()
                {
                    if (this.currentPath == "/") return "All Notes";
                    var t = this.currentPath.split("/");
                    if (t.length == 3) return ("/" + t[t.length - 2] + "/");
                    else return (".../" + t[t.length - 2] + "/");
                }
            },
            watch: 
            {
                currentPath(newPath, oldPath) 
                {
                    if (this.isAuthAvailable() == false) return;
                    this.updateCurrentDirectoryFiles();
                },
                currentPathFiles(newFilesList, oldFilesList)
                {

                }
            },
            data() 
            {
                var d = 
                {
                    loginUsername:"",
                    loginPassword:"",

                    currentPath:"", // this path is just the path in the nav view
                    currentWorkingPath:"", // working path is the full directory path of the current editing file
                    currentPathFiles:[],
                    currentNoteName:undefined,
                    editor: undefined,
                    socket: undefined,
                    //inactivityCounter: 0
                    isSocketDisconnected: false,
                    modifiedNoteNames: [],
                    isDirectoryLoading: true,
                    currentSearchWords: "",
                    currentTimeString: "",
                    secondsLeftToSaveNote: -1,
                    preventSaving: false,

                    isLoggedIn: false,
                    contextMenuTarget: undefined,
                    window: window,
                    pageHeight: window.innerHeight,
                    pageWidth: window.innerWidth,
                    currentPastedMedia: undefined,

                    maxWidthToBeMobile: 900
                }
                return d;
            },
            beforeUpdate()
            {
                var self = this;
                $(`#editorIframe`).get(0).onload = () => 
                {
                    self.editor = $(`#editorIframe`).get(0).contentWindow.editor;
                    var innerIframeDocument = $(`#editorIframe`).get(0).contentWindow;

                    self.editor.onCloseNote = () => 
                    {
                        self.currentNoteName = undefined;
                    };

                    // change due to computer/human input
                    $(`#editorIframe`).get(0).contentWindow.editor.on("change", () => 
                    {
                        console.log(2);
                        var sizeBytes = new Blob([self.editor.getValue()]).size;
                        if (sizeBytes < 1000) innerIframeDocument.$(`#sizeLabel`).get(0).innerText = `${sizeBytes} bytes`
                        else if (sizeBytes < 1000000) innerIframeDocument.$(`#sizeLabel`).get(0).innerText = `${sizeBytes / 1000} kB`
                        if (!self.preventSaving) self.secondsLeftToSaveNote = 2;
                    });

                    // // change due to human input
                    // $(`#editorIframe`).get(0).contentWindow.$(`textarea`).on("keyup", () => 
                    // {
                        
                    // });
                }

                // // automatically save notes if there's > 3 seconds inactivity
                // setInterval(() => 
                // {
                //     if (self.secondsLeftToSaveNote != -1) self.secondsLeftToSaveNote = Math.max(0, self.secondsLeftToSaveNote - 1);
                //     if (self.secondsLeftToSaveNote == 0)
                //     {
                //         self.saveNote();
                //         self.secondsLeftToSaveNote = -1;
                //     }
                // }, 1000);
            },
            mounted()
            {
                this.socket = io();
                var self = this;

                if (self.isAuthAvailable()) self.isLoggedIn = true;

                this.socket.on('connect', function() { self.isSocketDisconnected = false; });
                this.socket.on('disconnect', function() { self.isSocketDisconnected = true; });

                // If the current file is changed by other instances, update the newest content
                this.socket.on("fileChanged", (data) => 
                {
                    // Return if the fileChanged is caused by this client.
                    if (data.socketIdSource == self.socket.io.engine.id) return;
                    if (!self.modifiedNoteNames.includes(data.name)) { self.modifiedNoteNames.push(data.name); }
                    if (data.path == this.currentPath && data.name == this.currentNoteName && data.type == "note")
                    {
                        self.openNote(self.currentNoteName, true);
                    }
                });

                this.socket.on("directoryChanged", (data) => 
                {
                    // Return if the fileChanged is caused by this client.
                    // if (data.socketIdSource == self.socket.io.engine.id) return;
                    self.updateCurrentDirectoryFiles();
                });

                this.socket.on("noteRenamed", (data) => 
                {
                    // Return if the fileChanged is caused by this client.
                    // if (data.socketIdSource == self.socket.io.engine.id) return;
                    self.updateCurrentDirectoryFiles();

                    if (data.path == self.currentPath && data.oldName == self.currentNoteName)
                    {
                        self.currentNoteName = data.newName;
                    }
                });

                this.socket.on("folderRenamed", (data) => 
                {
                    // Return if the fileChanged is caused by this client.
                    // if (data.socketIdSource == self.socket.io.engine.id) return;
                    self.updateCurrentDirectoryFiles();
                });

                if (document.addEventListener) 
                {
                    document.addEventListener('contextmenu', function(e) 
                    {
                        var selectorContainer = e.target.parentNode;
                        console.log(e);
                        if (selectorContainer.dataset.type != undefined) 
                        { 
                            e.preventDefault();
                            self.contextMenuTarget = 
                            {
                                "type": selectorContainer.dataset.type,
                                "name":  selectorContainer.dataset.name,
                                "x": e.pageX,
                                "y": e.pageY,
                            }
                        }
                    }, false);
                } 

                // Listen for postMessage event coming from the editor iframe when images are pasted.
                window.onmessage = function(e) 
                {
                    if (e.data.name == 'imagePasted') 
                    {
                        self.currentPastedMedia = 
                        {
                            "type": "image",
                            "base64": e.data.base64
                        };
                    }
                };

                window.addEventListener("resize", () => 
                {
                    self.updateToolbarMode();
                });

                setInterval(() => 
                {
                    var options = { hour: '2-digit',minute:'2-digit', weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                    var today  = new Date();
                    self.currentTimeString = today.toLocaleDateString("en-US", options)
                }, 1000);

                var saveTimeInterval = 200;
                setInterval(() => 
                {
                    if (self.secondsLeftToSaveNote != -1) self.secondsLeftToSaveNote = Math.max(0, self.secondsLeftToSaveNote - (saveTimeInterval / 1000));
                    if (self.secondsLeftToSaveNote == 0) 
                    {
                        self.secondsLeftToSaveNote = -1;
                        self.saveNote();
                    }
                }, 200);

                this.currentPath = "/";                
            },
        }).mount('#app')
        </script>

        <style>
        * { transition: 0; font-family: 'Roboto', sans-serif; }
        .currentNote { background:#333; }
        .fullSize { width: 100%; height:100%; }
        .h1Min { margin:0px; padding:0px; color:white; font-size:16px; font-weight:100; }
        .verticallyCenter { display:flex; align-items: center; }
        .horiCenter { display:flex; justify-content: center; }
        .noteSelector { height: 50px; border-bottom:1px solid #333333; padding-left:30px; padding-right:20px; transition: all 0.1s ease; position:relative; }
        .noteSelector:hover { border-bottom:1px solid #333333; background: #555555; cursor:pointer; transition: all 0.1s ease; }
        .editormd-toolbar { border-bottom: 1px solid #333333 !important; border-left: 1px solid #333333 !important; }
        .materialIconDisabled { opacity: 0.3; cursor:not-allowed; }
        .noteModified { border-right: 1px solid orange !important; }
        .maxCenter { display:flex; width:100%; height:100%; justify-content: center; align-items: center; }
        .loadingIcon 
        {
            animation: loadingIcon 2s infinite linear;
            height: 32px;
            width: 32px;
            background: url("loadingIcon.png");
            background-size: contain;
        }
        @keyframes loadingIcon
        {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pasteModelConfirmButton 
        { 
            background: rgb(34, 34, 34); border: 0px none; margin-right: 15px;padding: 4px 10px 4px 10px; 
            border:1px #333333 solid; border-radius: 3px;
        }
        .pasteModelConfirmButton:hover
        { 
            background: #444444; cursor: pointer;
        }
        #mainGrid
        {
            display:grid; 
            grid-template-columns: minmax(300px,0.25fr) 1fr; 
            grid-template-rows:1fr; 
            grid-template-areas: 'left right'; width:100%; height:100%;
        }
        .leftPanelHidden { grid-template-columns: 0px 1fr !important; }
        .rightPanelHidden { grid-template-columns: 1fr 0px !important; }

        html {
            overflow: hidden;
            height: 100%;
        }

        body {
            height: 100%;
            overflow: auto;
        }

        #app { height:100%; }

        </style>

        <script type="text/javascript">

        </script>
    </body>
</html>